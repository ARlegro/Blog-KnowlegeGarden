---
{"dg-publish":true,"permalink":"/ë‚˜ë§Œë¬´/íŒŒì´ì¬ í‘œì¤€ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° íŒ¨í„´/","noteIcon":"","created":"2025-11-25T03:08:03.849+09:00","updated":"2025-11-25T03:35:44.860+09:00"}
---




## 1.  ë¬¸ì œì˜ ì½”ë“œ ğŸ’¢ 

AI-Agent ì±—ë´‡ì—ì„œ Langgraph.invokeë¥¼ êµ¬í˜„í–ˆë‹¤ê°€ ì½”ë“œë˜ë¹—í•œí…Œ í˜¼ë‚¬ë‹¤.
```PYTHON
#ğŸ’¢ë¬¸ì œë˜ëŠ” ì½”ë“œ 
final_state = agent_graph.invoke(initial_state, config)
```
ì´ ë°©ì‹ì€ ì™„ì „íˆ ë™ê¸° ì½”ë“œì´ë‹¤.
ë¬¸ì œëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ì—ì„œ ë™ê¸° ì½”ë“œë¥¼ ì§ì ‘í˜¸ì¶œí•œ ê²ƒì´ë‹¤
```python
@router.post("/chat/v2")
async def chat_v2(request: ChatRequest):
    ...
    final_state = agent_graph.invoke(initial_state, config)  # <- ì—¬ê¸°
    ...
```

## 2.  ë¬¸ì œ ì›ì¸ 
íŒŒì´ì¬ì˜ `async def`í•¨ìˆ˜ëŠ” ì´ë²¤íŠ¸ ë£¨í”„(loop)ìœ„ì— ëˆë‹¤
ì´ ë£¨í”„ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì”© ì‘ì—…ì„ ì‹¤í–‰í•˜ë©´ì„œ `await`ì§€ì ì—ì„œ ë‹¤ë¥¸ ì‘ì—…ìœ¼ë¡œ Context Switchingì„ í•´ì£¼ëŠ” êµ¬ì¡°ì´ë‹¤.


`agent_graph.invoke()`ëŠ” ë§¤ìš° ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ë‹¤.(ex. LLM í˜¸ì¶œ, íˆ´ í˜¸ì¶œ, ì¶”ë¡  ë“±)
ê·¼ë°, ì´ê±¸ awaitì—†ì´ í˜¸ì¶œí•˜ë©´ ì´ë²¤íŠ¸ ë£¨í”„ê°€ ê·¸ ë™ì•ˆ ì•„ë¬´ ê²ƒë„ ëª» í•˜ê³  Blockingì´ ëœë‹¤. ì´ë¡œ ì¸í•´
- ë‹¤ë¥¸ HTTP ìš”ì²­ë“¤ë„ ì²˜ë¦¬ ì§€ì—°
- ì†Œì¼“, ë‹¤ë¥¸ ë¹„ë™ê¸° ì‘ì—…ë„ ê°™ì´ ë¬µì´ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤ 



ì½”ë“œë˜ë¹—ì€ ì•„ë˜ì™€ ê°™ì€ ë¹„ë™ê¸°? ë°©ì‹ì„ ì¶”ì²œí–ˆë‹¤. FastAPIë¥¼ ê·¸ë˜ë„ ì–´ëŠì •ë„ ê³µë¶€ë¥¼ í•´ì•¼í•˜ë¯€ë¡œ ì´ ë°©ì‹ì´ ë­”ì§€ ìì„¸íˆ ì•Œì•„ë³¼ ê²ƒ 

## 3.  ì¶”ì²œ ë¹„ë™ê¸° íŒ¨í„´ 
> [!tip] run_in_executorë¥¼ ì´ìš©
> - ë™ê¸° í•¨ìˆ˜(LLM í˜¸ì¶œ, DB, ì™¸ë¶€ API ë“±)ë¥¼ **FastAPIì˜ ë¹„ë™ê¸° ì—”ë“œí¬ì¸íŠ¸ ë‚´ë¶€ì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©**í•˜ê¸° ìœ„í•œ ëŒ€í‘œ íŒ¨í„´
> - ìŠ¤ë ˆë“œ í’€ì—ì„œ ë”°ë¡œ ëŒë¦¬ê³  ê·¸ ê²°ê³¼ë§Œ ë¹„ë™ê¸°ë¡œ awaití•´ì„œ ë°›ê¸° 

### 3.1.  ì½”ë“œ ì˜ˆì‹œ ë° ì„¤ëª… 
```PYTHON
from functools import partial

# async def ì•ˆì—ì„œ ëŒê³  ìˆëŠ” ì´ë²¤íŠ¸ ë£¨í”„ ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ 
loop = asyncio.get_running_loop() 

final_state = await loop.run_in_executor(
	None,  # None = ê¸°ë³¸ ìŠ¤ë ˆë“œ í’€ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì˜ë¯¸
	partial(agent_graph.invoke, initial_state, config)
	# *args
)
```
âœ”`loop.run_in_executor(executor, func, *args) -> awaitable`
1. *ì²« ë²ˆì§¸ ì¸ì - executor*
	- `None` : ê¸°ë³¸ ìŠ¤ë ˆë“œ í’€ `Executor` ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì„¤ì •
	- ì§ì ‘ ë§Œë“¤ì–´ì„œ ë„£ì„ ìˆ˜ë„ ìˆë‹¤.
>[!tip] FastAPI ê¸°ë³¸ ìŠ¤ë ˆë“œ í’€
>CPU ì½”ì–´ ìˆ˜ X 5
	  
2. *ë‘ ë²ˆì§¸ ì¸ì - func*
	- ì‹¤ì œ ì‹¤í–‰í•  ë™ê¸° í•¨ìˆ˜
	  
3. *ì„¸ ë²ˆì§¸ ì¸ì - `*args`*
	- ë™ê¸° í•¨ìˆ˜ì— ë“¤ì–´ê°ˆ ì¸ìë“¤ 
	- `partial()`ë¡œ ë¯¸ë¦¬ ì¸ìë¥¼ ë°”ì¸ë”©í•˜ë©´ ì„¸ë²ˆì§¸ ì¸ìë„ í•„ìš” ì—†ìŒ

ì‹¤í–‰ íë¦„ ì •ë¦¬ 
1. `func(*args)`ë¥¼ ìŠ¤ë ˆë“œ í’€ ì•ˆì˜ ì›Œì»¤ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
2. ë©”ì¸ ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë‹¤ë¥¸ ì‘ì—… í•˜ëŸ¬ê°(ì‹¤ì œ func ì‘ì—…ì€ ì›Œì»¤ ìŠ¤ë ˆë“œê°€)
3. `func`ì´ ëë‚˜ë©´ ê·¸ ê²°ê³¼ë¥¼ ì´ë²¤íŠ¸ ë£¨í”„ì— ëŒë ¤ì¤Œ
4. ë©”ì¸ ë£¨í”„ëŠ” `await`ì§€ì ì—ì„œ ê²°ê³¼ë¥¼ ì´ì–´ë°›ìŒ

âœ”`partial(agent_graph.invoke, initial_state, config)`
- ì¸ìë¥¼ ë¯¸ë¦¬ ë„£ì–´ë‘” "í˜¸ì¶œ ì¤€ë¹„ëœ í•¨ìˆ˜"ë¥¼ ë§Œë“œëŠ” ê²ƒ 

### 3.2.  ì¥ì  
> [!question] ì´ íŒ¨í„´ì˜ ì¥ì ì€â“

1. *ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì§€ ì•ŠëŠ”ë‹¤ (Non-Blocking)*
	- `run_in_executor` ë‚´ë¶€ì—ì„œ ì›Œì»¤ ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ë  ë•Œ, ë©”ì¸ ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë‹¤ë¥¸ ì‘ì—… ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ â¡ë™ì‹œì„± ì¦ëŒ€
	- ì´ëŠ”, ë™ê¸° ì‘ì—…ì„ ìŠ¤ë ˆë“œ í’€ë¡œ ë¶„ë¦¬í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.
	  
2. *ëŒ€ê·œëª¨ LLM/DB/ì™¸ë¶€ API í˜¸ì¶œì—ì„œë„ ì•ˆì „*
	- ë™ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì˜ ë‹¤ë£° ìˆ˜ ìˆìŒ 
	- ì„œë²„ê°€ ë©ˆì¶”ì§€ ì•ŠëŠ”ë‹¤
	- ì²˜ë¦¬ëŸ‰ì´ ì„ í˜•ì ìœ¼ë¡œ ì¦ê°€í•œë‹¤.
	  
3. *ì´ë²¤íŠ¸ ë£¨í”„ ê¸°ë°˜ ê³ ì„±ëŠ¥ ì²˜ë¦¬ë¥¼ ìœ ì§€í•˜ë©´ì„œ ê¸°ì¡´ì˜ ë™ê¸° í•¨ìˆ˜ë“¤ì˜ ì•ˆì „í•œ ìš°íšŒ ì¥ì†Œ ì œê³µ *
	- ì†Œìˆ˜ì˜ ìŠ¤ë ˆë“œë¡œ ì—„ì²­ë‚œ ì•„ì›ƒí’‹ì„ ë‚´ëŠ” ì´ë²¤íŠ¸ ë£¨í”„ ê¸°ëŠ¥ì„ ìœ ì§€í•˜ë©´ì„œ ë™ê¸° í•¨ìˆ˜ ì²˜ë¦¬ ê°€ëŠ¥


### 3.3.  ë²ˆì™¸ - Langgraph + FastAPI íŒ¨í„´
```PYTHON
from functools import partial
import asyncio
from fastapi import APIRouter
from app.agent.graph import agent_graph

router = APIRouter()

@router.post("/chat/v2")
async def chat_v2(request: ChatRequest):
    initial_state = {
        "input": request.message,
        "session_id": request.session_id,
        # ...
    }
    config = {"configurable": {"thread_id": request.session_id}}

		âœ…
    loop = asyncio.get_running_loop()

		âœ…
    final_state = await loop.run_in_executor(
        None,
        partial(agent_graph.invoke, initial_state, config),
    )

    # final_state í›„ì²˜ë¦¬
    answer = extract_final_response(final_state)
    return ChatResponse(message=answer)
```
- LangGraphì˜ ë¬´ê±°ìš´ ë™ê¸° ì²˜ë¦¬ â†’ ìŠ¤ë ˆë“œ í’€ì—ì„œ ì²˜ë¦¬